---
title: "Life Expectancy"
author: "Pedro Delicado"
date: 'Simposio de Estadística, Ibagué, Colombia. 2023'
output: 
  html_document:
    number_sections: true
    toc: true
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE, eval=FALSE)
knitr::opts_chunk$set(echo = TRUE, eval=TRUE)
```

# Life expectancy. Countries of the World

## Reading data from United Nations

Extra Life Expectancy data have been [downloaded from the web page](https://population.un.org/wpp/Download/Standard/Extra Life Expectancy/) of 

> United Nations, Department of Economic and Social Affairs, Extra Life Expectancy Division (2022). *World Extra Life Expectancy Prospects 2022, Online Edition*.

Several data formats are available there. We are working with these data:

**Life expectancy at exact age, both sexes:** 
The average number of remaining years of life expected by a hypothetical cohort of individuals alive at age x who would be subject during the remaining of their lives to the mortality rates of a given year. It is expressed as years.

We have downloaded the file

> `WPP2022_MORT_F05_1_LIFE_EXPECTANCY_BY_AGE_BOTH_SEXES.xlsx`

```{r}
if (!file.exists("WPP2022_MORT_F05_1_LIFE_EXPECTANCY_BY_AGE_BOTH_SEXES.RData")){
 library(readxl)
  aux_names <- read_xlsx(
    "WPP2022_MORT_F05_1_LIFE_EXPECTANCY_BY_AGE_BOTH_SEXES.xlsx",
    sheet="Estimates", skip=16, n_max = 1)
  LifExp <- read_xlsx(
    "WPP2022_MORT_F05_1_LIFE_EXPECTANCY_BY_AGE_BOTH_SEXES.xlsx",
    sheet="Estimates", skip=1749, col_names = names(aux_names))
  # Removing rows corresponding to groups of countries or regions
  IndGroups <- which(is.na(LifExp$`ISO2 Alpha-code`))
  LifExp <- LifExp[-IndGroups,]
  rm(IndGroups)
  save(LifExp,file="WPP2022_MORT_F05_1_LIFE_EXPECTANCY_BY_AGE_BOTH_SEXES.RData") 
}else{
  load("WPP2022_MORT_F05_1_LIFE_EXPECTANCY_BY_AGE_BOTH_SEXES.RData")
}
```

```{r}
CtryName <- unique(LifExp$`Region, subregion, country or area *`)
CtryISO3 <- unique(LifExp$`ISO3 Alpha-code`)
CtryISO2 <- unique(LifExp$`ISO2 Alpha-code`)
Year <- unique(LifExp$Year)
AgeCh <- names(LifExp)[12:112]

nc <- length(CtryISO2)
ny <- length(Year)
nag <- length(AgeCh)
Age <- (1:nag) - 1

Country <- data.frame(Name=CtryName, ISO3=CtryISO3, ISO2=CtryISO2)
row.names(Country) <- CtryISO2
```

# Ploting and manipulating population pyramids 

We store the population pyramids data as 3 dimensional arrays,
**country** by **calendar_year** by **age**:
$$
X(c,t,a),
$$
where $c$ indicates the country (there are a total of 236 countries or areas),
$t\in \{1950,\dots,2021\}$ indicates the calendar year (72 years),
and $a\in\{0,\dots,100\}$ indicates the each,
except the last age interval, which is $[100,\infty)$. 

```{r}
if (!file.exists("LifeExpectancyCube0.RData")){
  LifExp3 <- array(data=NA, dim=c(nc,ny,nag),
                      dimnames = list(Country=CtryISO2, 
                                      Year=as.character(Year),
                                      Age=as.character(Age)) )
  for (i in (1:nc)){
    Ind_ctry <- which(LifExp$`ISO2 Alpha-code`==CtryISO2[i])
    LifExp3[i,,] <- as.matrix(LifExp[Ind_ctry,12:112])
  }
  save(LifExp3, Year, Age, Country,
         file="LifeExpectancyCube0.RData")
}else{
  load("LifeExpectancyCube0.RData")
}
```

As an example, here we have the population pyramids of Colombia and Spain for year `r (year <- 2021)`:

```{r}
#,fig.height=4,fig.width=6}
year <- 2021
ctry <- c('CO','ES')

matplot(Age, t(LifExp3[ctry,as.character(year),]), 
        lty=1, type="l", 
        ylab="Remaining years",
        main="Remaining life expectancy")
abline(h=2,lty=2,col=8)
legend("top", Country[ctry,1], lty=1, col=1:2, bty="n")

matplot(Age, 
        apply(t(LifExp3[ctry,as.character(year),]),2,
              function(x){x+Age}),
        lty=1, type="l",
        ylab="Years of live",
        main="Expected life length")
abline(a=0,b=1,lty=2,col=8)
legend("top", Country[ctry,1], lty=1, col=1:2, bty="n")

matplot(Age[-1],
        1+apply(t(LifExp3[ctry,as.character(year),]),2,diff),
        lty=1, type="l", 
        ylab="Years",
        main="Annual increase in expected life length")
abline(h=0,lty=2,col=8)
legend("top", Country[ctry,1], lty=1, col=1:2, bty="n")

matplot(Age[-1],
        log(1+apply(t(LifExp3[ctry,as.character(year),]),2,diff)),
        lty=1, type="l", 
        ylab="Years",
        main="Annual increase in expected life length, in logarithms")
abline(h=0,lty=2,col=8)
legend("top", Country[ctry,1], lty=1, col=1:2, bty="n")
```

We construct the data cube with the **log of annual increase in expected life length**:

```{r}
if (!file.exists("LifeExpectancyCube.RData")){
  Age.2 <- Age[-1]
  LifExp3diff <- array(data=NA, dim=c(nc,ny,nag-1),
                      dimnames = list(Country=CtryISO2, 
                                      Year=as.character(Year),
                                      Age=as.character(Age.2)) )
  for (i in (1:nc)){
    Ind_ctry <- which(LifExp$`ISO2 Alpha-code`==CtryISO2[i])
    LifExp3diff[i,,] <- log(1+ t(apply(LifExp3[i,,],1,diff)))
  }
    save(LifExp3, LifExp3diff, Year, Age, Age.2, Country,
         file="LifeExpectancyCube.RData")
}else{
  load("LifeExpectancyCube.RData")
}
```


# Many life expectancy curves at the same plot

We plot many life expectancy curves at the same graph:

```{r}
par(mfrow=c(2,2),mar=c(3,2,2,1))
matplot(Age,t(LifExp3['CO',,]), type="l", lty=1, 
        col=rainbow(length(Year), start=.2, end=1),
        xlab="Age",ylab="Extra Life Expectancy",
        main=paste0(Country['CO',1],", ",Year[1]," to ",rev(Year)[1]),
        cex.main=.75,cex.lab=.75,cex.axis=.75)
matplot(Age.2,t(LifExp3diff['CO',,]),type="l", lty=1, 
        col=rainbow(length(Year), start=.2, end=1),
        xlab="Age",ylab="Increase in Life Expectancy",
        main=paste0(Country['CO',1],", ",Year[1]," to ",rev(Year)[1]),
        cex.main=.75,cex.lab=.75,cex.axis=.75)

matplot(Age,t(LifExp3['ES',,]), type="l", lty=1, 
        col=rainbow(length(Year), start=.2, end=1),
        xlab="Age",ylab="Extra Life Expectancy",
        main=paste0(Country['ES',1],", ",Year[1]," to ",rev(Year)[1]),
        cex.main=.75,cex.lab=.75,cex.axis=.75)
matplot(Age.2,t(LifExp3diff['ES',,]),type="l", lty=1, 
        col=rainbow(length(Year), start=.2, end=1),
        xlab="Age",ylab="Increase in Life Expectancy",
        main=paste0(Country['ES',1],", ",Year[1]," to ",rev(Year)[1]),
        cex.main=.75,cex.lab=.75,cex.axis=.75)
```



## Alternative graphical representations

```{r perspective_plots,fig.width=8,fig.height=8}
par(mfrow=c(2,2),mar=c(1,1,1,1))
persp(Age,Year, t(LifExp3['CO',,]),
      theta = 30, phi = 30, expand = 0.5, col = "lightblue", 
      zlab="Extra Life Expectancy", main="Colombia. Extra Life Expectancy")
persp(Age.2,Year, t(LifExp3diff['CO',,]),
      theta = 30, phi = 30, expand = 0.5, col = "lightblue", 
      zlab="Increase in Life Expectancy", main="Colombia. log-Increase in Life Expectancy")
persp(Age,Year, t(LifExp3['ES',,]),
      theta = 30, phi = 30, expand = 0.5, col = "lightblue", 
      zlab="Extra Life Expectancy", main="Spain. Extra Life Expectancy")
persp(Age.2,Year, t(LifExp3diff['ES',,]),
      theta = 30, phi = 30, expand = 0.5, col = "lightblue", 
      zlab="Increase in Life Expectancy", main="Spain. log-Increase in Life Expectancy")
```

```{r, echo=FALSE, eval=FALSE}
filled.contour(Age, Year, t(LifExp3['CO',,]), asp=NA,
      color.palette = terrain.colors, main="Colombia. Extra Life Expectancy")
filled.contour(Age.2, Year, t(LifExp3diff['CO',,]), asp=NA,
      color.palette = terrain.colors, main="Colombia. log-Increase in Life Expectancy")
filled.contour(Age, Year, t(LifExp3['ES',,]), asp=NA,
      color.palette = terrain.colors, main="Spain. Extra Life Expectancy")
filled.contour(Age.2, Year, t(LifExp3diff['ES',,]), asp=NA,
      color.palette = terrain.colors, main="Spain. log-Increase in Life Expectancy")
```

```{r, fig.width=8,fig.height=7.3}
par(mfrow=c(2,2))
image(Age, Year, t(LifExp3['CO',,]), asp=1, xlab="", ylab="",
      col = terrain.colors(22), main="Colombia. Extra Life Expectancy")
image(Age.2, Year, t(LifExp3diff['CO',,]), asp=1, xlab="", ylab="",
      col=terrain.colors(22), main="Colombia. log-Increase in Life Expectancy")
image(Age, Year, t(LifExp3['ES',,]), asp=1, xlab="", ylab="",
      col = terrain.colors(22), main="Spain. Extra Life Expectancy")
image(Age.2, Year, t(LifExp3diff['ES',,]), asp=1, xlab="", ylab="",
      col=terrain.colors(22), main="Spain. log-Increase in Life Expectancy")
```

## Many countries, same year

```{r}
year <- 1950
year.ch <- as.character(year)
par(mfrow=c(2,2),mar=c(4,4,2,1))
matplot(Age,t(LifExp3[,year.ch,]), type="l",  
        xlab="Age",ylab="Extra Life Expectancy",
        main=paste0("Countries of the World. Year ",year),
        cex.main=.75,cex.lab=.75,cex.axis=.75)
matplot(Age.2,t(LifExp3diff[,year.ch,]),type="l", 
        xlab="Age",ylab="log-Increase in Life Expectancy",
        main=paste0("Countries of the World. Year ",year),
        cex.main=.75,cex.lab=.75,cex.axis=.75)

year <- 2021
year.ch <- as.character(year)
matplot(Age,t(LifExp3[,year.ch,]), type="l",  
        xlab="Age",ylab="Extra Life Expectancy",
        main=paste0("Countries of the World. Year ",year),
        cex.main=.75,cex.lab=.75,cex.axis=.75)
matplot(Age.2,t(LifExp3diff[,year.ch,]),type="l", 
        xlab="Age",ylab="log-Increase in Life Expectancy",
        main=paste0("Countries of the World. Year ",year),
        cex.main=.75,cex.lab=.75,cex.axis=.75)
```
```{r}
Country[which(LifExp3[,1,1]<25),1]
```



```{r}
year <- 1950
year.ch <- as.character(year)
par(mfrow=c(2,2),mar=c(4,4,2,1))
matplot(Age,t(LifExp3[,year.ch,]), type="l",  col=8, 
        xlab="Age",ylab="Extra Life Expectancy",
        main=paste0("Countries of the World. Year ",year),
        cex.main=.75,cex.lab=.75,cex.axis=.75)
lines(Age,LifExp3['CO',year.ch,],lwd=4, col=1)
lines(Age,LifExp3['ES',year.ch,],lwd=4, col=2)
legend("topright",Country[c('CO','ES'),1],lwd=4,col=1:2,bty="n")

matplot(Age.2,t(LifExp3diff[,year.ch,]), type="l",  col=8, 
        xlab="Age",ylab="log-Increase in Life Expectancy",
        main=paste0("Countries of the World. Year ",year),
        cex.main=.75,cex.lab=.75,cex.axis=.75)
lines(Age.2,LifExp3diff['CO',year.ch,],lwd=4, col=1)
lines(Age.2,LifExp3diff['ES',year.ch,],lwd=4, col=2)
legend("topright",Country[c('CO','ES'),1],lwd=4,col=1:2,bty="n")

year <- 2021
year.ch <- as.character(year)
matplot(Age,t(LifExp3[,year.ch,]), type="l",  col=8, 
        xlab="Age",ylab="Extra Life Expectancy",
        main=paste0("Countries of the World. Year ",year),
        cex.main=.75,cex.lab=.75,cex.axis=.75)
lines(Age,LifExp3['CO',year.ch,],lwd=4, col=1)
lines(Age,LifExp3['ES',year.ch,],lwd=4, col=2)
legend("topright",Country[c('CO','ES'),1],lwd=4,col=1:2,bty="n")

matplot(Age.2,t(LifExp3diff[,year.ch,]), type="l",  col=8, 
        xlab="Age",ylab="log-Increase in Life Expectancy",
        main=paste0("Countries of the World. Year ",year),
        cex.main=.75,cex.lab=.75,cex.axis=.75)
lines(Age.2,LifExp3diff['CO',year.ch,],lwd=4, col=1)
lines(Age.2,LifExp3diff['ES',year.ch,],lwd=4, col=2)
legend("bottomright",Country[c('CO','ES'),1],lwd=4,col=1:2,bty="n")
```